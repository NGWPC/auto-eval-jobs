id: fim_mosaicker
description: Mosaics and homogenizes overlapping flood observations (raster or vector) into a combined dataset with optional clipping/reprojection
outputTransmission:
  - reference # Indicates output metadata/path is transmitted, not the full data 

arguments:
  resolution:
    title: Target Resolution
    description: Output resolution in CRS units (applied to both X and Y dimensions). Required if output is raster.
    schema:
      type: number
      minimum: 0
      exclusiveMinimum: true # Resolution must be positive

  fim_type:
    title: FIM Type
    description: Type of flood inundation map output
    schema:
      type: string
      enum: [depth, extent]
      default: depth

  geo_mem_cache:
    title: Geocomputing Memory Cache
    description: GDAL cache size in megabytes for optimized raster processing
    schema:
      type: integer
      minimum: 64
      maximum: 4096
      default: 256

  region_tag:
    title: Region Tag
    description: An identifier tag for the processing region or job.
    schema:
      type: string 

inputs:
  raster_paths:
    title: Input Raster Paths
    description: Array of paths/URIs to input raster flood observations (e.g., GeoTIFFs).
    required: false # Assumes rasters might be optional if vectors are provided
    schema:
      type: array
      items:
        type: string
        format: uri
        contentMediaType: image/tiff; application=geotiff
      minItems: 1 

  hwm_paths:
    title: Input Multipoint Vector Paths
    description: Array of paths/URIs to input vector files containing multipoint geometries (e.g., GeoJSON, GeoPackage).
    required: false # Assumes vectors might be optional if rasters are provided
    schema:
      type: array
      items:
        oneOf:
          - type: string
            format: uri
            contentMediaType: application/geo+json
          - type: string
            format: uri
            contentMediaType: application/geopackage+gpkg
      minItems: 1 

  clip_geometry_path:
    title: Clipping Geometry Path
    description: Path/URI to a vector file (e.g., GeoJSON, GPKG) containing polygon(s) for clipping the output mosaic.
    required: false 
    schema:
      type: string
      format: uri

outputs:
  mosaic_output_path:
    title: Mosaicked Dataset Path
    description: Path for the unified flood observation output (Raster GeoTIFF or Vector GeoPackage, EPSG:5070).
    schema:
      oneOf: 
        - type: string
          format: uri 
          contentMediaType: image/tiff; application=geotiff
          properties: 
            crs:
              const: EPSG:5070
              description: Standard US analysis projection with equal area preservation
            units: meters
            dtype: uint8        
            nodata: 255         
            compression: lzw    
          when: 
            properties:
              fim_type:
                const: extent

        - type: string
          format: uri 
          contentMediaType: image/tiff; application=geotiff
          properties: 
            crs:
              const: EPSG:5070
              description: Standard US analysis projection with equal area preservation
            units: meters
            dtype: float32      
            nodata: -9999       
            compression: lzw    
          when: 
            properties:
              fim_type:
                const: depth
        - type: string
          format: uri 
          contentMediaType: application/geopackage+gpkg
          properties: 
            geometry_type: 
              type: string
              enum: [point, multipoint] 
            crs:
              const: EPSG:5070
              description: Albers Equal Area Continental US projection
